■■■ ymfmidi for Windows - FM MIDI synthesizer (ported by SimK) ■■■

ヤマハのFM音源をエミュレーションするymfm（https://github.com/aaronsgiles/ymfm）
をMIDIプレーヤーとして実装したymfmidi（https://github.com/devinacker/ymfmidi）
をさらにWindowsへ移植したものです。

本ソフトウェアは、ヤマハのOPL系チップのFM音源をエミュレーションし、Windowsの
MIDI環境（midiIn/Out API）からFM音源を利用可能にすることを目的としています。

□特徴
・FM音源風サウンドフォントではなく、完全なFM音源エミュレーション
　・YAMAHA OPL系チップ（種類選択可能）を再現
　・波形合成レベルでのエミュレーション
　・チップの複数使用によって同時発音数を増加可能
・従来のFM MIDIよりもMIDI仕様への互換性が向上
　・GM/GS/XGの処理に対応（音色定義を調整することで、さらに互換性を向上可能）
　・過去のWindows FM MIDIで正しく処理されていなかった仕様を修正
　　（ピッチベンド周りなど）
・WindowsネイティブなMIDIデバイスとして動作
　・MIDI INの入力を受け取れる常駐型ソフトウェアシンセサイザー
　・loopMIDI等の仮想MIDIケーブルを使用することで、
　　Windows標準のmidiOut API対応アプリケーションから利用可能
・リアルタイム再生＆オフラインレンダリング
　・MIDIメッセージをリアルタイムに処理し、音声出力可能
　・MIDI再生結果をWAVファイルとして書き出し可能
・常駐用に最適化
　・MIDIメッセージがないときは自動的にスリープ状態になるため、低消費電力
　・FM音源パラメータのみを保持するため、省メモリ


●動作環境
少なくともWindows 10以降では動くと思っています


●インストール
単にMIDIファイルプレーヤーとして使用する場合は特別な作業は要りません。
アーカイブを展開して好きな場所へ置くだけでOKです。

常駐させてMIDI INデバイスとして使用する場合は、MIDI INにケーブルを繋ぐか、
仮想MIDI INを用意してください。
実際にはあるソフトのMIDI OUTをそのまま受け取りたい場合が多いと思いますので、
これを実現できるloopMIDIというソフトウェアがおすすめです。
loopMIDIを使用すると、同じ名前のMIDI INとMIDI OUTが出現します。
これらは物理的にケーブルで繋がれているのと同じ振る舞いをしますので、
あるソフトのMIDI OUTとこのプログラムのMIDI INを同じloopMIDIデバイスにすれば
あるソフトで再生されたMIDIをそのままこのプログラムへ送り込んで再生出来ます。

最近のWindowsはMIDIマッパーがなくなったため、デフォルトのMIDI出力デバイスを変更
できなくなりました。変更したい場合はCoolSoft MIDIMapper等を使用してください。

デフォルトの音色定義ファイルは4オペレータを積極的に使う設計となっており、標準の
1チップでは同時発音数が不足しがちです。PC性能に余裕があればであれば-nオプション
で多数のOPL3を使用することをお勧めします。多数の音を鳴らすMIDIの場合-n 7くらい
までは聴いてわかる効果があると思います。


●アンインストール
レジストリは使用していませんのでそのまま削除してください。


●使い方
コンソール版のymfmidiwin.exe（OSが32bitの場合ymfmidiwin32.exe）と
常駐版のymfmidiwin-synth.exe（OSが32bitの場合ymfmidiwin-synth32.exe）の
2種類に分かれています。コンソール版はオリジナルのymfmidiに相当します。
・コンソール版 - MIDIファイル再生、MIDI→WAV変換、検証用途に使用
・常駐版 - WindowsのMIDI再生デバイスにする場合に使用

①MIDIファイルを再生・WAV変換する場合（コンソール版）
MIDIファイルを引数に指定して起動すると再生されます。
Windowsエクスプローラなら単にドラッグアンドドロップでOKです。

ymfmidiwin.exe MIDIファイル名

音色定義ファイル・OPLチップの種類・数などはコマンドライン引数で指示できます。
WAV変換したい場合は、/o . オプションを付けるのが簡単です。

ymfmidiwin.exe /o . MIDIファイル名

こうすると、元のMIDIファイル名に_ymfm.wavを付けたファイルに出力されます。

②WindowsのMIDI再生デバイスとして使う場合（常駐版）
◇準備
MIDI INデバイスが必要です。物理的に用意するか、loopMIDIなどの仮想MIDIケーブルを
インストールし、仮想MIDI INデバイスを作成してください。

◇起動
ymfmidiwin-synth.exe
のように起動すると、最初の MIDI INデバイスを使用してタスクトレイに常駐します。

◇MIDI INデバイスを指定する場合
ymfmidiwin-synth.exe -t //MIDIIN1
のように、//MIDIIN<番号>を指定することでMIDI IN デバイスを変更できます。

◇タスクトレイ常駐時の操作
タスクトレイアイコンを右クリックすると、以下の操作が可能です。
・[MIDI IN] - 使用中のMIDI INデバイスを表示
・[PATCH] - 使用中の音色定義ファイルを表示
・[MODE] - 現在の音源モードを表示
・Low-pass Filter - ローパスフィルタの設定
・MIDI Panic - 音が鳴りっぱなしになった場合に強制停止
・Reset - 指定モードで音源をリセット
・About - バージョン情報を表示
・Restart - アプリケーションを再起動（音が出なくなった場合など）
・Exit - 終了

◇コンソール版をMIDI INデバイスとして使う
コンソール版も//MIDIIN＜番号＞と書くとMIDI INデバイスモードになります。
この場合、コンソールで再生状況を確認できます。


●コンソール版コマンドライン引数の説明
ymfmidiwin [オプション] MIDIファイル名 [音色データファイル名]

対応MIDIファイルフォーマット:  HMI, HMP, MID, MUS, RMI, XMI
対応音色データフォーマット: AD, OPL, OP2, TMB, WOPL, FMSYNTH.BIN

MIDIファイル名として//MIDIINと書くとMIDI INデバイスとして常駐します。

オプション:
  -h / --help             コマンドライン引数などの説明を表示
  -q / --quiet            チップ状態の表示やキー動作を無効にする
  -1 / --play-once        1回だけ再生して終了する（デフォルトはループ再生）
  -s / --song <num>       複数曲がある場合にどれを再生するか指示(デフォルト1)
  -o / --out <path>       指定した名前のWAVファイルに変換して出力する
                          <path>が"."の場合はファイル名に_ymfm.wavを付けて出力

  -c / --chip <num>       チップ種別(1=OPL, 2=OPL2, 3=OPL3; デフォルト3)
  -n / --num <num>        チップ数(デフォルト1)
  -m / --mono             強制モノラル化 (OPL3の場合のみ)
  -b / --buf <num>        バッファサイズをバイト単位で指定（0で最小）
  --bufms <num(msec)>     バッファサイズをミリ秒で指定（デフォルト200msec, 0で最小）
  -g / --gain <num>       音量ゲイン(デフォルト1.0)
  -r / --rate <num>       WAV出力サンプリングレート(デフォルト44100)
  --hpfilter <num>        Hz単位のハイパスフィルタカットオフ (default 5, 0=無効)
  --lpfilter <num>        Hz単位のローパスフィルタカットオフ (default 16000, 0=無効)

  -p / --ptime            スリープ状態へ移行する時間(ミリ秒単位; default 15000)

  --resampler <nearest|linear|sinc_fast|sinc_medium|sinc_best>
                          サンプリング変換のタイプを指示
                          デフォルトはsinc_fastです
                          ・nearest: 最近傍補間。エイリアシング出まくり低品質
                          ・linear: 線形補間。許せるレベルの品質で低負荷
                          ・sinc_fast: sinc補間（高速）。バランスがよい
                          ・sinc_medium: sinc補間（中）。性能に余裕がある人向け
                          ・sinc_best: sinc補間（高品質）。かなり高負荷
  --tail-time <num>       WAV出力時に末尾に追加する時間(ミリ秒単位)
                          末尾の余韻が切れてしまう場合に使用します
                          指定しない場合は余韻分の時間を自動判定します

※MIDIファイル名と音色データ名は必ずオプションの後に書く必要があります。
オフションの前にファイル指定すると動きません。

□典型的なオプション例
OPL2化する
ymfmidiwin -c 2

同時に126音鳴らせるようにする（大富豪サウンド）
ymfmidiwin -n 7

指定したMIDIファイルをWAVファイルへ出力する
ymfmidiwin -o WAVファイル名 MIDIファイル名

□オリジナルのymfmidiにない機能
MIDI INデバイスモード（コンソール）
ymfmidiwin //MIDIIN

指定したMIDIファイルを_ymfm.wavを付けてへ出力する
ymfmidiwin -o . MIDIファイル名
→ 例えば、test.midならtest_ymfm.wavへ出力


●常駐版コマンドライン引数の説明
コンソール版と同じオプションが使用できます。
ただし、コンソール表示がなくなるため再生状況などの確認はできません。


●Windows FM MIDIパッチファイル（FMSYNTH.BIN）について
Windows標準のFM MIDI音源に近い音色で再生したい場合、Windows標準のSound Blaster 
16ドライバで使用されている音色パラメータが必要になります。この実体はWindows NT4 DDKサンプルに含まれるFMSYNTH.BINです。

ただし、このパラメータ定義は本来ドライバ開発用（DDK）に含まれるものであり、
目的外での再配布は適切でない可能性があるため、本ソフトウェアにはFMSYNTH.BINを
同梱していません。その代替手段として以下の方法に対応しています。

①DDKサンプルのFMSYNTH.BINを使用する方法
Windows NT4 DDKに含まれるSound Blaster 16 サンプルドライバのFMSYNTH.BINを
音色定義ファイルとして指定すると読み込めます。

（例1）ymfmidiwin hogehoge.mid FMSYNTH.BIN
（例2）ymfmidiwin-synth FMSYNTH.BIN

②ドライバDLLから読み込む方法
実はWindows NT4用のSound Blaster系ドライバのDLL（例：sndblst.dllなど）には、
FMSYNTH.BINと同一内容のデータがリソースとして含まれています。

そのため、本ソフトウェアではFMSYNTH.BIN相当のリソースを含むDLLファイルを指定
した場合も、そのリソースから音色データを読み込めるようにしています。

（例1）ymfmidiwin hogehoge.mid sndblst.dll
（例2）ymfmidiwin-synth sndblst.dll

FMSYNTH.BIN相当のリソースが含まれていればsndblst.dllでなくても構いません。

◇ドラム音色について
FMSYNTH.BINに含まれるドラム音色はOPLのリズム音に依存していますが、リズム音は
現在のymfmidiでは未対応です。そのため、ドラム音色のみGENMIDI.op2から読み込む
実装になっています。
GENMIDI.op2をymfmidiwin.exeと同じフォルダに配置してください。


●動作負荷について
本ソフトウェアはFM音源チップを波形合成レベルでエミュレーションしているため、
再生時のCPU負荷は比較的高めになります。

負荷が大きかったり音飛びが発生する場合は以下のオプションをお試しください。
・--quiet または -q（コンソール版）
描画や状態表示を省略し、負荷を軽減できます。
・--resampler linear
サンプリング変換を線形補間にすることで、再生品質を妥協して負荷を下げます。
最近傍補間（nearest）はエイリアシングノイズが激しく出るのでおすすめしません。
・--bufms 200
バッファを200msecにして余裕を持たせます。遅延は大きくなります。


●常駐時のスリープ機能について
常駐モードでは、常にMIDI INを受信可能な状態で待機しています。この際にOPLを常時
稼働状態に維持するとCPUを無駄に消費してしまいます。そこで、本ソフトウェアには
一定時間MIDIメッセージが来なかった時に、OPLエミュレーションと音声出力を停止する
（スリープ状態にする）仕組みが用意されています。

デフォルトでは、15秒間MIDIメッセージが受信出来ないときにスリープ状態へ移行し、
スリープ中にMIDIメッセージを受信すると自動的に復帰します。

この待機時間は、-p <時間(ms)> オプションで変更できます。
-p 0 を指定すると、スリープ機能を無効化します。


●ローパスフィルタについて
--lpfilterオプションまたはタスクトレイアイコンの右クリックメニューからローパス
フィルタの設定ができます。ローパスフィルタは高域成分を緩やかに減衰させます。
これにより耳障りさを低減し、より自然で聴きやすい音になります。


●免責事項
本プログラムはフリーソフト＆無保証です。本プログラムを使用したことで何らかの
損害が発生したとしても、作者は一切の責任を負わないものとします。


●バージョン履歴
2025/12/30 ver.0.6.3.5
・音飛びが発生しにくいように対策
・ドラムの音が消える問題をさらに対策

2025/12/30 ver.0.6.3.4
・上書きによってドラムの音が消えやすかったのを消えにくくした
・バッファサイズ指定が効いていなかったのを修正

2025/12/30 ver.0.6.3.3
・常駐版でエラー時のメッセージを確認できなかった問題を修正
・出力にローパスフィルタを適用できるようにした

2025/12/27 ver.0.6.3.2
・ドラムの音色定義が音が鳴り続ける設定の時永久に音が止まらない問題を修正

2025/12/26 ver.0.6.3.1
・ドラムのノートオフの扱いを間違えていたのを修正
・スリープ状態からの復帰時に音のタイミングが不安定になりにくくした

2025/12/25 ver.0.6.3.0
・コンソール版と常駐版を分離してセキュリティソフト誤検知をされにくくした
・音色定義が読めなかったとき終了し損なうバグを修正
・スリープ時のポーリングを止めてさらにCPU負荷を下げた

2025/12/24 ver.0.6.2.2
・MIDI Panic周辺の実装を整理した
・常駐時の右クリックメニューに使用している音色パッチ等を表示するようにした

2025/12/23 ver.0.6.2.1
・GS Resetが誤爆してしまう不具合を修正
・XG Resetされない不具合を修正

2025/12/22 ver.0.6.2.0 
・Windows FM MIDIパッチファイル FMSYNTH.BINを読めるようにした
・32bit版コンソールモードで表示がおかしくなっていたのを修正

2025/12/21 ver.0.6.1.0 
・オーディオ出力先の変更に追従するようにした
・デバイスの出力形式を変えても落ちないようにした
・WAV変換時に末尾の余韻を残すようにした

2025/12/21 ver.0.6.0.1 
・オールxx系コマンドの扱いを間違えていたのを修正
・右クリックメニューでリスタートできるようにした

2025/12/20 ver.0.6.0.0 
初版（ymfmidi ver.0.6より移植）

------------------------
Neko Project 21/W 開発者
SimK
